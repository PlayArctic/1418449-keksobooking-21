(()=>{"use strict";(()=>{let e=document.querySelector(".map");window.card={renderCard:function(t){if(!t||!t.target.dataset.id)return;let r=document.querySelector("#card").content.cloneNode(!0),o=t.target.dataset.id;var n;document.querySelector(".map__card")&&document.querySelector(".map__card").remove(),n=o,r.querySelector(".popup__title").textContent=window.filter.getFilteredAds()[n].offer.title,function(e,t){e.querySelector(".popup__text--address").textContent=window.filter.getFilteredAds()[t].offer.address}(r,o),function(e,t){let r=e.querySelector(".popup__text--price");r.textContent=[],r.innerHTML=window.filter.getFilteredAds()[t].offer.price+"₽<span> /ночь</span>"}(r,o),function(e,t){e.querySelector(".popup__type").textContent=window.filter.getFilteredAds()[t].offer.TYPE}(r,o),function(e,t){e.querySelector(".popup__text--capacity").textContent=`${window.filter.getFilteredAds()[t].offer.rooms} комнаты для ${window.filter.getFilteredAds()[t].offer.guests} гостей`}(r,o),function(e,t){e.querySelector(".popup__text--time").textContent=`Заезд после ${window.filter.getFilteredAds()[t].offer.checkin}, выезд до ${window.filter.getFilteredAds()[t].offer.checkout}`}(r,o),function(e,t){let r=e.querySelector(".popup__features"),o=document.createDocumentFragment(),n=window.filter.getFilteredAds()[t].offer.features;for(let e=0;e<n.length;e++){let t=document.createElement("li");t.classList.add("popup__feature","popup__feature--"+n[e]),o.appendChild(t)}r.textContent=[],r.appendChild(o)}(r,o),function(e,t){e.querySelector(".popup__description").textContent=window.filter.getFilteredAds()[t].offer.description}(r,o),function(e,t){let r=document.createDocumentFragment(),o=window.filter.getFilteredAds()[t].offer.photos,n=e.querySelector(".popup__photos");for(let e=0;e<o.length;e++){let t=document.createElement("img");t.style.src=o[e],t.style.width="45px",t.style.height="40px",t.alt="Фотография жилья",t.classList.add("popup__photo"),r.appendChild(t)}n.textContent=[],n.appendChild(r)}(r,o),function(e,t){e.querySelector(".popup__avatar").src=window.filter.getFilteredAds()[t].author.avatar}(r,o),e.appendChild(r),document.querySelector(".popup__close")&&document.querySelector(".popup__close").addEventListener("click",(function(){document.querySelector(".map__card").remove()}))}}})(),(()=>{let e,t="any",r={type:t,price:t,rooms:t,guests:t,features:{wifi:!1,dishwasher:!1,parking:!1,washer:!1,elevator:!1,conditioner:!1}};const o=function(){e=window.loadData.getData().filter((function(e){return function(e){let o;return e.offer.price<1e4?o="low":e.offer.price>1e4&&e.offer.price<5e4?o="middle":e.offer.price>5e4&&(o="high"),r.price===t||r.price===o}(e)&&function(e){return r.type===t||r.type===e.offer.type}(e)&&function(e){return r.rooms===t||parseInt(r.rooms,10)===e.offer.rooms}(e)&&function(e){return r.guests===t||parseInt(r.guests,10)===e.offer.guests}(e)&&function(e){for(let t in r.features)if(r.features[t]&&!e.offer.features.includes(t))return!1;return!0}(e)})),window.pin.renderPins(e)};document.querySelector(".map__filters").addEventListener("change",(function(e){switch(document.querySelectorAll("button[data-id]").forEach((function(e){e.remove()})),document.querySelector(".map__card")&&document.querySelector(".map__card").remove(),e.target.id){case"housing-type":r.type=e.target.value;break;case"housing-price":r.price=e.target.value;break;case"housing-rooms":r.rooms=e.target.value;break;case"housing-guests":r.guests=e.target.value;break;case"filter-wifi":r.features.wifi?r.features.wifi=!1:r.features.wifi=!0;break;case"filter-dishwasher":!1===r.features.dishwasher?r.features.dishwasher=!0:r.features.dishwasher=!1;break;case"filter-parking":!1===r.features.parking?r.features.parking=!0:r.features.parking=!1;break;case"filter-washer":!1===r.features.washer?r.features.washer=!0:r.features.washer=!1;break;case"filter-elevator":!1===r.features.elevator?r.features.elevator=!0:r.features.elevator=!1;break;case"filter-conditioner":!1===r.features.conditioner?r.features.conditioner=!0:r.features.conditioner=!1}o()})),window.filter={updateData:o,getFilteredAds:function(){return e}}})(),(()=>{document.querySelector(".map__pins").addEventListener("click",window.card.renderCard),document.querySelector(".map__pins").addEventListener("keydown",(function(e){"Enter"===e.code&&window.card.renderCard(e)})),document.addEventListener("keydown",(function(e){"Escape"===e.code&&document.querySelector(".map__card")&&document.querySelector(".map__card").remove()}));let e=document.querySelector(".map__pin--main"),t=document.querySelector(".map--faded"),r=document.querySelectorAll(".map__filter"),o=document.querySelector(".map__features"),n=document.querySelector(".ad-form--disabled"),a=document.querySelectorAll(".ad-form__element"),i=document.querySelector("#address"),u=function(){i.value=`${e.style.left.replace(/px/,"")-32}, ${e.style.top.replace(/px/,"")-62}`,i.setAttribute("readonly","readonly")};!function(){for(let e of a)e.setAttribute("disabled","disabled");for(let e of r)e.setAttribute("disabled","disabled");o.setAttribute("disabled","disabled")}(),e.addEventListener("mousedown",(function(e){1===e.which&&document.querySelector(".map--faded")&&(u(),d())})),e.addEventListener("keydown",(function(e){"Enter"===e.code&&document.querySelector(".map--faded")&&(u(),d())}));let d=function(){t.classList.remove("map--faded"),n.classList.remove("ad-form--disabled"),window.loadData.getServerData(window.filter.updateData),function(){for(let e of a)e.removeAttribute("disabled");for(let e of r)e.removeAttribute("disabled");o.removeAttribute("disabled")}(),window.card.renderCard()};window.listeners={setCurrentAddress:u}})(),(()=>{let e=[],t=function(e){let t=document.createElement("div");t.style="border-radius: 0 0 5px 5px; z-index: 100; margin: 0 auto; text-align: center; background-color: orange;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="24px",t.style.fontFamily="Roboto",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)};window.loadData={getServerData:function(r){let o=new XMLHttpRequest;o.addEventListener("load",(function(){let n;switch(o.status){case 200:e=JSON.parse(o.responseText),r(e);break;case 400:n="Неверный запрос";break;case 401:n="Пользователь не авторизован";break;case 404:n="Ничего не найдено";break;default:n="Cтатус ответа: : "+o.status+" "+o.statusText}n&&t(n)})),o.addEventListener("error",(function(){t("Произошла ошибка соединения")})),o.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+o.timeout+"мс")})),o.timeout=1e4,o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},getData:function(){return e}}})(),window.pin={renderPins:function(e){let t=document.querySelector("#pin").content.querySelector(".map__pin"),r=document.querySelector(".map__pins"),o=document.createDocumentFragment();const n=Math.min(e.length,5);for(let r=0;r<n;r++){let n=t.cloneNode(!0),a=n.querySelector("img");n.setAttribute("data-id",r),n.style.left=e[r].location.x-20+"px",n.style.top=e[r].location.y-40+"px",a.src=e[r].author.avatar,a.alt=e[r].offer.title,a.setAttribute("data-id",r),o.appendChild(n)}return r.appendChild(o)}},(()=>{let e=document.querySelector(".map__pin--main");e.addEventListener("mousedown",(function(t){let r={x:t.clientX,y:t.clientY},o=!1,n=function(t){t.preventDefault(),o=!0;let n=r.x-t.clientX,a=r.y-t.clientY;r={x:t.clientX,y:t.clientY};let i=function(e,t,r){return(e=parseInt(e,10))>r?r:e<t?t:e};e.style.top=i(e.offsetTop-a,130,630)+"px",e.style.left=i(e.offsetLeft-n,0,1130)+"px",window.listeners.setCurrentAddress()},a=function(t){if(t.preventDefault(),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",a),o){let t=function(r){r.preventDefault(),e.removeEventListener("click",t)};e.addEventListener("click",t)}};document.addEventListener("mousemove",n),document.addEventListener("mouseup",a)}))})(),(()=>{let e=function(e){let o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(function(){let e;switch(o.status){case 200:t();break;case 400:e="Неверный запрос";break;case 401:e="Пользователь не авторизован";break;case 404:e="Ничего не найдено";break;default:e="Cтатус ответа: : "+o.status+" "+o.statusText}e&&r(e)})),o.addEventListener("error",(function(){r("Произошла ошибка соединения")})),o.addEventListener("timeout",(function(){r("Запрос не успел выполниться за "+o.timeout+"мс")})),o.timeout=1e4,o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(e)},t=function(){let e=document.querySelector("#success").content.cloneNode(!0).querySelector(".success");e.classList.add("overlay"),document.body.insertAdjacentElement("afterbegin",e),document.querySelector(".overlay").addEventListener("click",(function(){this.remove()})),document.addEventListener("keydown",(function(e){"Escape"===e.code&&document.querySelector(".overlay").remove()}))},r=function(e){let t=document.querySelector("#error").content.cloneNode(!0);t.querySelector(".error").classList.add("overlay"),t.querySelector(".error__message").textContent=e,document.body.appendChild(t),document.querySelector(".overlay").addEventListener("click",(function(){this.remove()})),document.addEventListener("keydown",(function(e){"Escape"===e.code&&document.querySelector(".overlay")&&document.querySelector(".overlay").remove()})),document.querySelector(".error__button").addEventListener("click",(function(e){"Escape"===e.code&&document.querySelector(".overlay").remove()}))},o=document.querySelector("#adForm");o.addEventListener("submit",(function(t){t.preventDefault(),e(new FormData(o))})),window.upload={uploadData:e}})(),(()=>{let e=document.querySelector("#adForm");const t={1:["1"],2:["1","2"],3:["1","2","3"],100:["0"]};e.addEventListener("input",(function(e){let t=e.target.id,d=e.target;switch(t){case"title":r(d);break;case"price":o(d);break;case"type":n();break;case"timein":a(d);break;case"timeout":i(d);break;case"room_number":u()}}));let r=function(e){e.addEventListener("input",(function(){let t=e.value.length;t<30?e.setCustomValidity("Еще "+(30-t)+" символов."):t>100?e.setCustomValidity("Удалите лишние "+(t-100)+" символов."):e.setCustomValidity(""),e.reportValidity()}))},o=function(e){e.setAttribute("required","required"),e.value>1e6?e.setCustomValidity("Цена не должна превышать 1000000"):e.setCustomValidity(""),e.reportValidity()},n=function(){let e=document.querySelector("#price"),t=document.querySelector("#type");"bungalow"===t.value?(e.setAttribute("min","0"),e.setAttribute("placeholder","0")):"flat"===t.value?(e.setAttribute("min","1000"),e.setAttribute("placeholder","1000")):"house"===t.value?(e.setAttribute("min","5000"),e.setAttribute("placeholder","5000")):"palace"===t.value&&(e.setAttribute("min","10000"),e.setAttribute("placeholder","10000"))},a=function(e){let t=document.querySelector("#timeout");"12:00"===e.value?t.value="12:00":"13:00"===e.value?t.value="13:00":"14:00"===e.value&&(t.value="14:00")},i=function(e){let t=document.querySelector("#timein");"12:00"===e.value?t.value="12:00":"13:00"===e.value?t.value="13:00":"14:00"===e.value&&(t.value="14:00")},u=function(){let e=document.querySelector("#room_number").value;Array.from(document.querySelector("#capacity").options).forEach((function(r){t[e].includes(r.value)?(r.removeAttribute("disabled"),r.setAttribute("selected","")):(r.setAttribute("disabled",""),r.removeAttribute("selected"))}))};window.validation.setTypeDependencies(),window.validation.setGuestDependencies(),window.validation.setAllowedFiles()})()})();